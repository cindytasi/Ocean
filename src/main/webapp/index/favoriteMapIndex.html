<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBg0fuT9wJNXI_3ZUwFiwJmG1iSV-N6Pzo&libraries=places"></script>
</head>

</head>

<style>
    :root {
        --bs-blue: #81D8D0;
    }

    /* 頁面背景色 */
    body {
        background: #000;

    }

    /* 清單 */
    .navbar-dark .navbar-nav .nav-link:focus,
    .navbar-dark .navbar-nav .nav-link:hover {
        color: var(--bs-blue)
    }

    .navbar {
        background: #000;
    }

    /* search */
    .bi {
        color: #fff;
        font-size: 25px;
    }

    .bi:hover {
        color: #81D8D0;
    }

    /* 下拉選單 */
    .dropdown-item:hover {
        font-size: 20px;
        color: rgb(9, 163, 130);
    }

    /* footer */
    .footer_detail li>a {
        color: #fff;
        text-decoration: none;
    }

    .footer_detail li>a:hover {
        color: var(--bs-blue);
    }



    /* CSS代碼 */
    .tabs {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .nav-tabs {
        display: flex;
        flex-direction: row-reverse;
    }

    .tab-content {
        display: flex;
        flex-direction: row-reverse;
    }

    #map {
        height: 100%;
    }

    .nav-tabs .nav-item.show .nav-link,
    .nav-tabs .nav-link.active {
        color: #81D8D0;
        background-color: #fff;
        /* border-color: #dee2e6 #dee2e6 #fff; */
    }

    .nav-link {
        color: #fff;
    }
</style>

<body>

    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top mb-5">
        <div class="container-fluid">
            <div class="collapse navbar-collapse justify-content-between" id="navbarNavDropdown">
                <!-- logo -->
                <div class="logo d-flex">
                    <a class="navbar-brand" href="../index/oceanIndex.html">
                        <img src="../logo/logo_-_.png" alt="Ocean Logo" style="width: 50px;height: 50px;">
                    </a>
                    <!-- search -->
                    <div class="input-group my-auto w-50 dropdown">
                        <input type="text" class="form-control dropdown-toggle" id="searchInput" placeholder="Search"
                            aria-label="Search" aria-describedby="basic-addon2" data-bs-toggle="dropdown"
                            aria-expanded="false">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">
                            <i class="bi bi-search"></i>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="searchInput"
                            style="width: 400px; height: 100px;background-color: rgba(0, 0, 0, 0.5);" id="searchVideo">
                            <!-- <div class="card mb-3">
                                <div class="row g-0">
                                    <div class="col-md-4">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSneeWcVqMfMeHC0tLaVFfwcjAgPpRq6jaXYg&usqp=CAU" alt="..." style="width: 150px; height: 100px;">
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card-body">
                                            <p class="card-text">This is a wider card with supporting text below as a
                                                natural lead-in to additional content. This content is a little bit
                                                longer.</p>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                        </ul>

                    </div>
                </div>
                <!-- 導覽列 -->
                <div class="list">
                    <ul class="navbar-nav align-items-center">
                        <!-- 首頁 -->
                        <li class="nav-item">
                            <a class="nav-link active" href="../index/oceanIndex.html">首頁</a>
                        </li>
                        <!-- 電影 -->
                        <li class="nav-item">
                            <a class="nav-link" href="../index/movieIndex.html">電影</a>
                        </li>
                        <!-- 影集 -->
                        <li class="nav-item">
                            <a class="nav-link" href="../index/seriesIndex.html">影集</a>
                        </li>
                        <!-- 藝人商品 -->
                        <li class="nav-item">
                            <a class="nav-link" href="/Ocean/MainShopServlet">藝人商品</a>
                        </li>
                        <!-- 收藏地圖 -->
                        <li class="nav-item">
                            <a class="nav-link active" style="color:#81D8D0"
                                href="../index/favoriteMapIndex.html">收藏地圖</a>
                        </li>
                        <!--user  -->
                        <div class="nav-item dropdown">
                            <button type="button" class="btn dropdown-toggle" id="navbarDropdownUserLink"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <!-- <img src="../img/user.webp" alt="" style="width: 40px; height: 40px;"> -->
                                <img src="" alt="" id="userImg" style="width: 40px;height: 40px;">
                            </button>
                            <!-- user下拉選單 -->
                            <ul class="dropdown-menu dropdown-menu-end mt-2" style="opacity: 80%;"
                                aria-labelledby="navbarDropdownUserLink">
                                <li><a class="dropdown-item" href="../index/aacountIndex.html">帳戶</a></li>
                                <li><a class="dropdown-item" href="../index/accountDetail.html">基本資料</a></li>
                                <li><a class="dropdown-item" href="../index/myAchieve.html">我的成就</a></li>
                                <li><a class="dropdown-item" href="../index/myOrder.html">我的訂單</a></li>
                                <li><a class="dropdown-item" href="../index/myList.html">我的片單</a></li>
                                <li><a class="dropdown-item" href="../index/watchHistory.html">觀看紀錄</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="../index/signOut.html">登出</a></li>
                            </ul>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!--收藏地圖  -->
    <div class="container">
        <h3 class="text-light">收藏地圖</h3>

        <!-- 地圖容器 -->
        <div id="map" style="height: 400px;"></div>

        <!-- 頁籤容器 -->
        <div class="tabs mt-2">
            <ul class="nav nav-tabs flex-row-reverse" id="myTab" role="tablist">
                <!-- 頁籤 -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link bg-light active" id="add-tab" type="button" role="tab" aria-controls="add"
                        aria-selected="true">
                        <i class="fa-solid fa-plus" style="color: #81D8D0; font-size: 20px;"></i>
                    </button>
                </li>
            </ul>
            <div class="tab-content flex-row-reverse" id="myTabContent">
                <!-- 頁籤內容 -->
                <div class="tab-pane fade show active mt-2" id="add" role="tabpanel" aria-labelledby="add-tab">
                    <!-- 新增頁籤表單 -->
                    <form id="addTabForm">

                    </form>
                </div>
            </div>
        </div>

        <!-- 景點list -->
        <div id="attractionList" class="mb-5">
            <!-- <div class="attractionCard1 card flex-row" style="width: 100%;">
                <img src="https://i0.wp.com/post.medicalnewstoday.com/wp-content/uploads/sites/3/2019/02/GettyImages-629363759_header-1024x575.jpg?w=1155&h=1528"
                    style="width: 10%;" class="card-img-top" alt="...">
                <div class="card-body" id="attractionDetail">
                    <p class="card-text">xxxx遊樂園</p>
                    <p class="card-text">地址：xxxxx</p>
                    <p class="card-text">電話：xxxxxx</p>
                </div>
                <div class="card-btn d-flex">
                    <div class="booking my-auto me-4">
                        <button type="button" class="btn" style="color: #81D8D0; background-color: #000;">預約</button>
                    </div>
                    <div class="like my-auto">
                        <i class="bi bi-heart-fill" style="color: #81D8D0;font-size: 30px"></i>
                    </div>
                    <div class="moreDetail mt-auto">
                        <i class="bi bi-caret-down-fill" style="color: #81D8D0;" data-bs-toggle="collapse"
                            href="#attractionIntroduce" aria-controls="collapseExample" aria-expanded="false"></i>
                    </div>
                </div>
            </div>
            <div class="collapse" id="attractionIntroduce">
                <div class="card card-body">
                    Some placeholder content for the collapse component. This panel is hidden by default but
                    revealed when
                    the user activates the relevant trigger.
                </div>
            </div> -->
        </div>




        <!-- 頁尾 -->
        <div class="container mt-5">
            <ul class="footer_detail d-flex justify-content-center list-unstyled">
                <li class="px-2"><a href="../index/qaIndex.html">常見問題</a></li>
                <li class="px-2"><a href="../index/privacyAndTerms.html">隱私權</a></li>
            <li class="px-2"><a href="../index/legalNotices.html">法律聲明</a></li>
                <li class="px-2"><a href="../index/aboutUs.html">關於我們</a></li>
            </ul>
            <span class="d-flex justify-content-center">Copyright© 2023 Ocean.All rights reserved.</span>
        </div>


        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
        <script src="https://kit.fontawesome.com/755328616c.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8"
            crossorigin="anonymous"></script>

        <script>
            //=================================從session取得memberId======================================//
            const memberId = sessionStorage.getItem("memberId");

            //=================================搜尋使用者img======================================//
            document.getElementById("userImg").setAttribute("src", "http://localhost:8080/Ocean/web/controller/selectMemberImgController?memberId=" + memberId );

            //==============================================動態生成景點列表============================================================//

            $.ajax({
                url: "/Ocean/web/controller/favoriteMapController", // 資料請求的網址
                type: "POST",
                dataType: "json",
                data: JSON.stringify({
                    memberId: 1
                }),
                success: function (data) {

                    let att = document.getElementById('attractionList');

                    for (let i in data) {

                        att.innerHTML += `
                        <div class="attractionCard${i} card flex-row" style="width: 100%;" id="attractionCard">
                            <img src="https://i0.wp.com/post.medicalnewstoday.com/wp-content/uploads/sites/3/2019/02/GettyImages-629363759_header-1024x575.jpg?w=1155&h=1528"
                            style="width: 10%;" class="card-img-top" alt="...">
                            <div class="card-body" id="attractionDetail${i}">
                                <p class="card-text"> ${data[i].attractionName}</p>
                                <p class="card-text">地址： ${data[i].address} </p>
                                <p class="card-text">電話： ${data[i].phoneNumber}</p>
                            </div>
                            <div class="card-btn d-flex">
                                <div class="booking my-auto me-4">
                                    <button type="button" class="btn" style="background-color: #000;">
                                        <a href = "${data[i].googleMapLink}" style="text-decoration:none;color:#81D8D0">預約</a>    
                                    </button>
                                </div>
                                <div class="like my-auto" >
                                    <button type="button" class="btn" id="like${i}">
                                        <i class="bi bi-heart-fill" style="color: #81D8D0;font-size: 30px;"></i>
                                    </button>
                                </div>
                                <div class="moreDetail mt-auto">
                                    <i class="bi bi-caret-down-fill" style="color: #81D8D0;" data-bs-toggle="collapse"
                                        href="#attractionIntroduce${i}" aria-controls="collapseExample" aria-expanded="false"></i>
                                </div>
                            </div>
                        </div>
                        <div class="collapse" id="attractionIntroduce${i}">
                            <div class="card card-body">
                                ${data[i].attractionIntroduce}
                            </div>
                        </div>
                        `;

                        // 找到所有 "like" 按鈕並對它們綁定 click 事件
                        const likeButtons = document.querySelectorAll('[id^="like"]');
                        likeButtons.forEach((button, y) => {
                            button.addEventListener("click", function () {
                                console.log(data[y].attractionId);

                                const attractionCard = document.querySelector(`.attractionCard${y}`);

                                if (attractionCard) {
                                    const attractionId = data[y].attractionId;
                                    $.ajax({
                                        url: "/Ocean/web/controller/favoriteMapDeleteController", // 資料請求的網址
                                        type: "POST",
                                        dataType: "json",
                                        data: JSON.stringify({
                                            memberId: 1,
                                            attractionId: attractionId
                                        }),
                                        success: function (response) {
                                            // 修改图标
                                            const likeButton = attractionCard.querySelector('i.bi.bi-heart-fill');
                                            if (likeButton) {
                                                likeButton.classList.remove('bi-heart-fill');
                                                likeButton.classList.add('bi-heart');
                                            }
                                            console.log("OK")
                                            attractionCard.remove();
                                            if (markers[y]) {
                                                markers[y].setMap(null); // 从地图上移除标记
                                            }
                                        },
                                        error: function (error) {
                                            console.log(error);
                                        }
                                    });
                                }
                            });
                        });
                    };

                    //======================================================動態生成地標============================================================//

                    // 以下開始是建立地圖跟自訂地標
                    // 設定初始地圖位置
                    var mapOptions = {
                        center: { lat: 23.463506660158448, lng: 121.26632281405502 },
                        // 地圖放大倍數
                        zoom: 6
                    };

                    // 建立map物件
                    var map = new google.maps.Map(document.getElementById('map'), mapOptions);
                    // 建立map info物件=>info是地標會顯示的資訊
                    var infoWindow = new google.maps.InfoWindow();
                    //  建立markers陣列 為了把每個景點的marker裝進去 如果沒有的話會因為新的一直覆蓋上去而抓不到每個景點的資訊
                    var markers = [];
                    //建立contentStrings陣列，跟上面markers陣列功能一樣，避免覆蓋問題
                    var contentStrings = [];

                    // 透過迴圈將景點資訊裝去陣列裡 方便之後拿出來
                    for (let i in data) {

                        // marker資訊
                        var marker = new google.maps.Marker({
                            position: { lat: data[i].latitude, lng: data[i].longitude },
                            map: map,
                            title: data[i].attractionName,
                            customAttr: 1
                        });
                        markers.push(marker);

                        // 設置info視窗的內容
                        var contentString = `
                        <div>
                            <h3>${data[i].attractionName}</h3>
                            <p>地址：${data[i].address}</p>
                            <p>電話：${data[i].phoneNumber}</p>
                        </div>    
                            `;
                        contentStrings.push(contentString);

                        // 建立click事件，點擊地標時顯示資訊視窗
                        $(document).on('click', `#attractionDetail${i}`, function () {
                            infoWindow.setContent(contentStrings[i]);
                            infoWindow.open(map, markers[i]);
                        });
                    }
                }
            });

             //=================================SEARCH Video FUNCTION======================================//

        let lastSearchText = '';
        $(document).ready(function () {
            $("#searchButton").click(function () {
                $("#searchInput").focus();
            });
        });

        const searchInput = document.getElementById("searchInput");
        const sv = document.getElementById('searchVideo');

        searchInput.addEventListener("keypress", function (e) {

            if (e.keyCode === 13) {
                const searchText = searchInput.value.trim();

                if (searchText === '') {
                    sv.innerHTML = '';
                    return;
                }

                // 清空之前搜尋的結果
                sv.innerHTML = '';

                // 更新上一次的搜尋內容
                lastSearchText = searchText;

                $.ajax({
                    url: "/Ocean/web/controller/indexSearchVideoController",
                    type: "POST",
                    dataType: "json",
                    data: JSON.stringify({
                        videoName: searchText
                    }),
                    success: function (data) {

                        let starRatings = []; // 用來存放每一筆資料的星星數量

                        for (let i in data) {

                            // 將字串轉換為數字
                            const videoReview = parseInt(data[i].VideoReview, 10); // 假設 data[i].VideoReview 是一個範圍為 "1" 到 "5" 的字串

                            // 將星星數量放入陣列
                            starRatings.push(videoReview);

                            // 生成星星 icon
                            let starsHtml = '';
                            for (let j = 1; j <= 5; j++) {
                                const starClass = j <= videoReview ? 'bi bi-star-fill checked' : 'bi bi-star';
                                starsHtml += `<i class="${starClass}" data-rating="${j}" style="color:#81D8D2"></i>`;
                            }

                            let card = document.createElement('div');
                            card.classList.add('card');
                            card.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                            card.innerHTML = `
                            <div class="row g-0">
                                <div class="col-md-4">
                                    <img src="http://localhost:8080/Ocean/web/controller/selectVideoImgController?videoId=${data[i].videoId}" alt="..." style="width: 150px; height: 100px;">
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body text-left ms-2">
                                        <h4 class="card-text" style="color: white;">${data[i].videoName}</h4>
                                        <div class="stars" style="color: white;">${starsHtml}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                            sv.appendChild(card);
                        }
                    }
                })
            }
        });

        // 在搜尋欄失去焦點時檢查是否需要清空搜尋結果
        searchInput.addEventListener("blur", function () {
            const searchText = searchInput.value.trim();
            if (searchText === '') {
                sv.innerHTML = '';
            }
        });

        // 在搜尋欄重新獲得焦點時檢查是否需要重新顯示上一次的搜尋結果
        searchInput.addEventListener("focus", function () {
            const searchText = searchInput.value.trim();
            if (searchText === '' && lastSearchText !== '') {
                searchInput.value = lastSearchText;
                // 觸發 Enter 鍵事件，重新顯示上一次的搜尋結果
                const enterEvent = new KeyboardEvent("keypress", { keyCode: 13 });
                searchInput.dispatchEvent(enterEvent);
            }
        });

            //=====================================================頁籤功能==============================================================//

            document.addEventListener("DOMContentLoaded", function () {
                const addTabBtn = document.getElementById("add-tab");
                const tabContent = document.getElementById("myTabContent");
                let tabIndex = 1;

                addTabBtn.addEventListener("click", function () {
                    // 建立新的頁籤
                    const newTab = document.createElement("div");
                    newTab.className = "tab-pane fade";
                    newTab.id = "tab" + tabIndex;
                    newTab.setAttribute("role", "tabpanel");

                    // 新增輸入框和儲存按鈕到新的頁籤
                    newTab.innerHTML = `
            <input type="text" id="tabNameInput" placeholder="輸入頁籤名稱">
            <button id="saveTabBtn" class="rounded-pill" style="background-color:white;color:#81D8D0">儲存</button>
            <button id="deleteTabBtn" class="rounded-pill" style="background-color:white;color:#81D8D0">刪除</button>
        `;

                    // 將新的頁籤新增到頁籤內容區域
                    tabContent.appendChild(newTab);

                    // 顯示新的頁籤
                    const newTabLink = document.createElement("li");
                    newTabLink.className = "nav-item";
                    newTabLink.innerHTML = `
            <button class="nav-link" id="tab${tabIndex}-tab" data-bs-toggle="tab" data-bs-target="#tab${tabIndex}" type="button" role="tab" aria-controls="tab${tabIndex}" aria-selected="true">
                New Tab
            </button>
        `;
                    const tabList = document.getElementById("myTab");
                    tabList.appendChild(newTabLink);

                    // 激活新的頁籤
                    const tabLink = newTabLink.querySelector(".nav-link");
                    const activeTabLinks = document.querySelectorAll(".nav-link.active");
                    activeTabLinks.forEach(function (link) {
                        link.classList.remove("active");
                    });
                    tabLink.classList.add("active");

                    const activeTabs = document.querySelectorAll(".tab-pane.active");
                    activeTabs.forEach(function (tab) {
                        tab.classList.remove("active", "show");
                    });
                    newTab.classList.add("active", "show");

                    // 增加頁籤索引
                    tabIndex++;

                    // 處理儲存按鈕的點擊事件
                    const saveTabBtn = newTab.querySelector("#saveTabBtn");
                    const tabNameInput = newTab.querySelector("#tabNameInput");
                    saveTabBtn.addEventListener("click", updateTabName);
                    tabNameInput.addEventListener("keydown", function (event) {
                        if (event.key === "Enter") {
                            updateTabName();
                        }
                    });

                    // 處理刪除按鈕的點擊事件
                    const deleteTabBtn = newTab.querySelector("#deleteTabBtn");
                    deleteTabBtn.addEventListener("click", function () {
                        // 將頁籤從頁籤列表中刪除
                        newTabLink.remove();
                        newTab.remove();
                    });

                    function updateTabName() {
                        const tabName = tabNameInput.value;
                        // 將使用者輸入的頁籤名稱顯示在頁籤標籤上
                        tabLink.textContent = tabName;
                    }
                });
            });
        </script>
</body>

</html>